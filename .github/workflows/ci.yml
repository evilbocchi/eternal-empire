name: Continuous Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allow manual triggering for releases
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 1.0.0)'
        required: true
        default: ''
      create_release:
        description: 'Create GitHub Release'
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    environment: ci
    
    env:
      ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
      ROBLOX_GROUP_ID: ${{ secrets.ROBLOX_GROUP_ID }}
      LUAU_EXECUTION_API_KEY: ${{ secrets.LUAU_EXECUTION_API_KEY }}
      LUAU_EXECUTION_UNIVERSE_ID: ${{ secrets.LUAU_EXECUTION_UNIVERSE_ID }}
      LUAU_EXECUTION_PLACE_ID: ${{ secrets.LUAU_EXECUTION_PLACE_ID }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build project
      run: npm run build
    
    - name: Run tests
      run: npm test
      continue-on-error: false

    - name: Create build artifact directory
      run: mkdir -p build-artifacts

    - name: Get version from package.json
      id: get-version
      if: github.event_name == 'push'
      shell: bash
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Set release version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          echo "release_version=${{ steps.get-version.outputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "release_version=${{ github.event.inputs.version || 'latest' }}" >> $GITHUB_OUTPUT
        fi

    - name: Package project files
      run: |
        # Create a zip file with all necessary files
        zip -r build-artifacts/jme-${{ steps.version.outputs.release_version }}.zip \
          out/ \
          assets/ \
          include/ \
          default.project.json \
          README.md \
          LICENSE

    - name: Create GitHub Release
      if: ${{ inputs.create_release }}
      uses: softprops/action-gh-release@v1
      with:
        files: build-artifacts/jme-${{ steps.version.outputs.release_version }}.zip
        tag_name: v${{ steps.version.outputs.release_version }}
        name: v${{ steps.version.outputs.release_version }}
        body: |          
          This release was automatically generated by GitHub Actions.
          
          ## Changes
          
          _Please manually update this section with the relevant changes._
        draft: true
        prerelease: false
        token: ${{ github.token }}

  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
    
    - name: Check for outdated packages
      run: npm outdated
      continue-on-error: true